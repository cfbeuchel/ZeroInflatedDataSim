---
output:
  html_document:
    toc: true
    number_sections: false
    toc_depth: 3
author: "Carl Beuchel"
date: "`r format(Sys.time(), '%d %B, %Y')`"
editor_options: 
  chunk_output_type: console
---

```{r knitr, cache = F, results = "markup", echo = T, warning = T}
# start with a clean workspace
rm(list=ls())
gc()

# Set the global knitr options
knitr::opts_chunk$set(cache = F, results = "hide", echo = T ,include = T)

# what should the output file be called?
filename = "STEP 2: Zero-inflated data exploration"
```

# `r filename`
***
This script is a small data simulation to help figure out an appropriate data transformation withouth loosing too much statistical power in the subsequent regression analyses.

```{r initiate, cache = F, results = "hide", echo = F}
# choose correct working directory
r_on_server <- T
if (r_on_server == T) {
  basicpath <- "/net/ifs1/san_projekte/projekte/"
} else {
  basicpath <- "/mnt/ifs1_projekte/"
}
setwd(basicpath)

# set working directory
pathwd <-
  paste0(
    basicpath,
    "genstat/02_projekte/1703_ge_metab_a1_b3_sorbs/171124_ZeroInflatedDataSim"
  )
setwd(pathwd)

# get additional functions from Holger Kirstens newest RProfile file
newest_rprofile <-
  function(designation = paste0(basicpath, "genstat/07_programme/rtools/RProfile_hk/")) {
    files <- list.files(designation)
    RProfiles <- files[grep("Rprofile_hk_", files)]
    newest_RProfile <- tail(sort(RProfiles), n = 1)
    suppressPackageStartupMessages(source(paste0(designation, newest_RProfile)))
  }
newest_rprofile()

# start time measurement, define alternative package directory, define start codes for external start of the script
if (r_on_server == T) {
  initializeSkript(myfilename = filename, computer = "forostar") # enter which server you are on
} else
  initializeSkript(myfilename = filename, computer = "local")

# Packages
for (i in c(
  "knitr",
  "data.table",
  "MASS",
  "ggplot2",
  "scales"
)) {
  suppressPackageStartupMessages(library(i, character.only = TRUE))
}
```

## Data simulation and setup

```{r load}
# load the simuation results
all.scenarios <- fread("/mnt/ifs1_projekte/genstat/02_projekte/1703_ge_metab_a1_b3_sorbs/171124_ZeroInflatedDataSim/results/171204_SimulationResults.csv")
```

### Additional Functions

```{r add.func}
# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

# create a -log10 transformation for scales
minuslog10_trans <- function() trans_new("minuslog10", function(x) -log10(x), function(x) 10(-x))
```

## Exploratory plots

### Plot pvalues against each other

```{r explore}
# dicho pvalues plotted against linmod pvalues for different effect sizes
pdf("/mnt/ifs1_projekte/genstat/02_projekte/1703_ge_metab_a1_b3_sorbs/171124_ZeroInflatedDataSim/plots/171128_dicho&LogitVsLinmodPvalsPerEffekt.pdf", width = 21)
lapply(unique(all.scenarios$effekt), function(x){
  
  p1 <- ggplot(all.scenarios[proz0 == 20 & effekt == x, ], aes(-log10(linmod.pval), -log10(dicho.pval), colour = logit.pval)) +
    geom_point() +
    facet_grid(categart ~ categnum, scales = "free") +
    scale_x_continuous(breaks = pretty_breaks(4)) +
    scale_y_continuous(breaks = pretty_breaks(10)) +
    theme_minimal() + 
    ggtitle(label = paste0("dicho ~ linmod pvalues for effect size of ", x)) +
    scale_color_distiller(palette="Spectral")
  
  p2 <- ggplot(all.scenarios[proz0 == 20 & effekt == x, ], aes(-log10(linmod.pval), -log10(logit.pval), color = dicho.pval)) +
    geom_point() +
    facet_grid(categart ~ categnum, scales = "free") +
    scale_x_continuous(breaks = pretty_breaks(4)) +
    scale_y_continuous(breaks = pretty_breaks(10)) +
    theme_minimal() +
    ggtitle(label = paste0("logit ~ linmod pvalues for effect size of ", x)) +
    scale_color_distiller(palette="Spectral")
  
  multiplot(p1, p2, cols = 2)
})
dev.off()

# dicho.pval ~ logit.pval
pdf("/mnt/ifs1_projekte/genstat/02_projekte/1703_ge_metab_a1_b3_sorbs/171124_ZeroInflatedDataSim/plots/171128_logitVsDichoPvalsPerEffect&0infl.pdf", width = 21)
lapply(unique(all.scenarios$proz0), function(y){
  lapply(unique(all.scenarios$effekt), function(x){
  
ggplot(all.scenarios[proz0 == y & effekt == x, ], aes(-log10(logit.pval), -log10(dicho.pval), colour = linmod.pval)) +
    geom_point() +
    facet_grid(categart ~ categnum, scales = "free") +
    scale_x_continuous(breaks = pretty_breaks(4)) +
    scale_y_continuous(breaks = pretty_breaks(5)) +
    theme_minimal() + 
    ggtitle(label = "dicho ~ logit pvalues", subtitle = paste0("Effect-size= ", x, " and zero-inflation by ", y, "%")) +
    scale_color_distiller(palette="Spectral")
  })
})
dev.off()

# filter by pvalue, e.g. only those with high dicho pval etc
# dicho.pval ~ logit.pval
pdf("/mnt/ifs1_projekte/genstat/02_projekte/1703_ge_metab_a1_b3_sorbs/171124_ZeroInflatedDataSim/plots/171128_logitVsDichoPvalsPerEffect&0infl&PvalFiltered", width = 21)
lapply(unique(all.scenarios$proz0), function(y){
  lapply(unique(all.scenarios$effekt), function(x){
  
ggplot(all.scenarios[proz0 == y & effekt == x & linmod.pval <= 0.05, ],
       aes(y = -log10(logit.pval),
           x = -log10(dicho.pval),
           colour = linmod.pval)) +
    geom_point() +
    facet_grid(categart ~ categnum, scales = "free") +
    scale_x_continuous(breaks = pretty_breaks(4)) +
    scale_y_continuous(breaks = pretty_breaks(5)) +
    theme_minimal() + 
    ggtitle(label = "dicho ~ logit pvalues", subtitle = paste0("Effect-size= ", x, " and zero-inflation by ", y, "%")) +
    scale_color_distiller(palette="Spectral")
  })
})
dev.off()

# number of categories as deciding factor
all.scenarios[linmod.pval <= 0.05, sum(logit.pval <= 0.05), by = .(categart,categnum)]
all.scenarios[linmod.pval <= 0.05, sum(dicho.pval <= 0.05), by = .(categart,categnum)]
```

### Boxplots of pvalues

```{r boxplots}
# based on fdr-corrected linmod pvals, show boxplot of pvalue distribution of all three methods
test <- melt(data = all.scenarios[linmod.pval <= 0.05, ],
             id.vars = c("effekt", "proz0", "categart", "categnum"),
             measure.vars = c("dicho.pval", "linmod.pval", "logit.pval"))

# for all linmod.pval <= 0.05 plot the pvalue distribution for each effekt and zero-inflation percentage
pdf("/mnt/ifs1_projekte/genstat/02_projekte/1703_ge_metab_a1_b3_sorbs/171124_ZeroInflatedDataSim/plots/171128_logitVsDichoPvalsBoxPlotByLinmod005.pdf")

# outer loop for proz0
lapply(unique(all.scenarios$proz0), function(y){
  
  # inner loop for effect size
  lapply(unique(all.scenarios$effekt), function(x){
    
    ggplot(test[proz0 == y & effekt == x], aes(x = as.factor(categnum), y = -log10(value), fill = variable)) + 
      geom_boxplot() + coord_flip() + 
      facet_wrap( ~ categart, scales = "free_x") + 
      scale_fill_brewer(palette="Spectral") +
      ggtitle(label = "dicho, logit & linmod pvalues for linmod.pval <= 0.05",
              subtitle = paste0("Effect-size = ", x, " and zero-inflation by ", y, "%")) +
      theme_minimal()
  })
})

dev.off()

# show boxplot of pvalue distribution of all three methods for all pvalues
test.2 <- melt(data = all.scenarios,
               id.vars = c("effekt", "proz0", "categart", "categnum"),
               measure.vars = c("dicho.pval", "linmod.pval", "logit.pval"))

# for all pvalues: plot the pvalue distribution 
pdf("/mnt/ifs1_projekte/genstat/02_projekte/1703_ge_metab_a1_b3_sorbs/171124_ZeroInflatedDataSim/plots/171128_logitVsDichoBoxRawPvals.pdf")

# outer loop for proz0
lapply(unique(all.scenarios$proz0), function(y){
  
  # inner loop for effect size
  lapply(unique(all.scenarios$effekt), function(x){
    
    ggplot(test.2[proz0 == y & effekt == x],
           aes(x = as.factor(categnum),
               y = -log10(value),
               fill = variable)) + 
      geom_boxplot() +
      coord_flip() + 
      facet_wrap( ~ categart) + 
      scale_fill_brewer(palette="Spectral") +
      ggtitle(label = "dicho, logit & linmod pvalues",
              subtitle = paste0("Effect-size = ", x, " and zero-inflation by ", y, "%")) +
      theme_minimal()
  })
})

dev.off()

# boxplot of pvals for all linmod pvals <= 0.05 
test.3 <- melt(data = all.scenarios[linmod.pval <= 0.05, ],
               id.vars = c("effekt", "proz0", "categart", "categnum"),
               measure.vars = c("dicho.pval", "linmod.pval", "logit.pval"))

# for all linmod.pval <= 0.05 plot the pvalue distribution for each effekt and zero-inflation percentage
pdf("/mnt/ifs1_projekte/genstat/02_projekte/1703_ge_metab_a1_b3_sorbs/171124_ZeroInflatedDataSim/plots/171128_logitVsDichoPvalsBoxPlotByLinmod005.pdf")

# outer loop for proz0
lapply(unique(all.scenarios$proz0), function(y){
  
  # inner loop for effect size
  lapply(unique(all.scenarios$effekt), function(x){
    
    ggplot(test.3[proz0 == y & effekt == x],
           aes(x = as.factor(categnum),
               y = -log10(value),
               fill = variable)) + 
      geom_boxplot() +
      # coord_trans(y = "minuslog10") + 
      coord_flip() +
      facet_wrap( ~ categart) + 
      scale_fill_brewer(palette = "Spectral") +
      ggtitle(label = "dicho, logit & linmod pvalues for linmod.pvalues <= 0.05",
              subtitle = paste0("Effect-size = ", x, " and zero-inflation by ", y, "%")) +
      theme_minimal()
  })
})

dev.off()
```



```{r zoom.in}
# logit seems to outperform dicho glm
# look more closely at logit vs lm
# betas correlate well
ggplot(all.scenarios[effekt == 0.01 & proz0 == 20 & categart == "quantile" & categnum == 2, ],
       aes(x = linmod.beta,
           y = logit.beta)) +
  geom_abline(intercept = 0, slope = 1, lty = 2, col = "red") +
  geom_point()


# über realisationen mitteln
test.6 <- all.scenarios[, mean(logit.pval), by = .(effekt, proz0, categart, categnum)]
q.vs.b <- dcast.data.table(data = test.6, formula = effekt + proz0 + categnum ~ categart, value.var = "V1")

# plot bereiche ~ quantile
ggplot(q.vs.b,
       aes(x = -log10(bereiche),
           y = -log10(quantile),
           color = as.factor(categnum),
           pch = as.factor(proz0))) +
        facet_wrap(~effekt, scale = "free") + 
  geom_point(alpha = 0.7) + 
  geom_abline(intercept = 0, slope = 1)

# results show little difference between the two in terms of power

  
  
# check out other statistics 
test.4 <- melt(data = all.scenarios[linmod.fdr <= 0.05, ],
               id.vars = c("effekt", "proz0", "categart", "categnum"),
               measure.vars = c("linmod.fdr", "logit.fdr", "logit.pval", "linmod.pval", "linmod.r2", "linmod.beta", "logit.beta"))

pdf("/mnt/ifs1_projekte/genstat/02_projekte/1703_ge_metab_a1_b3_sorbs/171124_ZeroInflatedDataSim/plots/171130_logitPvalsByEffectPerCategory.pdf", height = 14)
# look at logit pvals 
ggplot(test.4[proz0 == 20 & effekt %in% c(0.01, 0.02, 0.05) & variable == "logit.pval", ],
       aes(y= value,
           x = as.factor(categnum),
           fill = as.factor(effekt))) +
  geom_boxplot() +
  facet_grid( ~ as.factor(categart)) + 
  coord_flip(ylim = c(0,0.1)) +
  scale_fill_brewer(palette="Spectral") +
  theme_minimal()
dev.off()
```

```{r over.realizations}
ggplot(test.6, aes(x = categnum, y = -log10(V1), pch = as.factor(categart), color = factor(proz0))) +
  facet_wrap(~ effekt, scale = "free") +
  geom_smooth(aes(group = paste(factor(proz0), categart), lty = categart), alpha = 0.2, fullrange=T, span = 1.5) +
  geom_point(size = 2.5) +
  theme_minimal()



```


### Compare with rank-correlation

After I determined the optiomal szenario I can compare the results with rank correlation

```{r compare.rank}
# boxplot of pvals pearson
all.scenarios[ , lapply(.SD,function(x) mean(x)), by = .(effekt, proz0, categart, categnum),
               .SDcols = c("logit.pval", "pearson.cor.pval", "effekt", "proz0", "categart", "categnum")]


test.5 <- melt(data = all.scenarios,
               id.vars = c("effekt", "proz0", "categart", "categnum"),
               measure.vars = c("logit.pval", "pearson.cor.pval"))
dcast.data.table(data = test.5, formula = effekt + proz0 + categart + categnum ~ variable, value.var = "value")

# for all linmod.pval <= 0.05 plot the pvalue distribution for each effekt and zero-inflation percentage
pdf("/mnt/ifs1_projekte/genstat/02_projekte/1703_ge_metab_a1_b3_sorbs/171124_ZeroInflatedDataSim/plots/171128_logitVsPearsonPvalsBoxPlotByLinmod005.pdf")

# outer loop for proz0
lapply(unique(all.scenarios$proz0), function(y){
  
  # inner loop for effect size
  lapply(unique(all.scenarios$effekt), function(x){
    
    ggplot(test.5[proz0 == y & effekt == x],
           aes(x = as.factor(categnum),
               y = -log10(value),
               fill = variable)) + 
      geom_boxplot() +
      # coord_trans(y = "minuslog10") + 
      coord_flip() +
      facet_wrap( ~ categart) + 
      scale_fill_brewer(palette = "Spectral") +
      ggtitle(label = "logit & pearson pvalues for linmod.pvalues <= 0.05",
              subtitle = paste0("Effect-size = ", x, " and zero-inflation by ", y, "%")) +
      theme_minimal()
  })
})

dev.off()

# scatterplots of significant pvals based on optimal linmod pvals

pdf("/mnt/ifs1_projekte/genstat/02_projekte/1703_ge_metab_a1_b3_sorbs/171124_ZeroInflatedDataSim/plots/171128_logitVsPearsonPvalsScatterPlotByLinmod005.pdf", width = 21)

# outer loop for proz0
lapply(unique(all.scenarios$proz0), function(y){

lapply(unique(all.scenarios$effekt), function(x){
  
 ggplot(all.scenarios[proz0 == y & effekt == x & linmod.pval <= 0.05, ],
        aes(-log10(logit.pval), -log10(pearson.cor.pval), color = -log10(linmod.pval))) +
    geom_point() +
    facet_grid(categart ~ categnum) +
    scale_x_continuous(breaks = pretty_breaks(5)) +
    scale_y_continuous(breaks = pretty_breaks(5)) +
    theme_minimal() + 
      ggtitle(label = "logit & pearson pvalues for linmod.pvalues <= 0.05",
              subtitle = paste0("Effect-size = ", x, " and zero-inflation by ", y, "%")) +
    scale_color_distiller(palette="Spectral", name = "linmod pvals \n as -log10")
  })
})

dev.off()

# No of sig pvals 
all.scenarios[linmod.pval <= 0.05, sum(logit.pval <= 0.05), by = .(categart,categnum)]
all.scenarios[linmod.pval <= 0.05, sum(pearson.cor.pval <= 0.05), by = .(categart,categnum)]
```

```{r save}
# write.table(x = all.scenarios,
#             file = paste0(pathwd, "/results/",
#                           format(Sys.time(), '%y%m%d'),
#                           "_SimulationResults.csv"),
#             sep = "\t", row.names = F)
```

```{r SessionInfo, echo=F, results='markup'}
sessionInfo()
```            